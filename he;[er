local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local player = Players.LocalPlayer

-- Track toggle state
local toggled = false
local toggleButtonRef = nil

-- Create persistent ScreenGui in CoreGui
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ToggleSyncGUI"
screenGui.Parent = CoreGui

-- Create label to show toggle state
local label = Instance.new("TextLabel")
label.Size = UDim2.new(0, 200, 0, 50)
label.Position = UDim2.new(0.5, -100, 0, 10)
label.BackgroundColor3 = Color3.fromRGB(30,30,30)
label.TextColor3 = Color3.new(1,1,1)
label.TextScaled = true
label.Text = "TOGGLE OFF"
label.Parent = screenGui

-- Function to safely click the toggle button
local function clickDeltaButton(button)
	if not button then return end
	for _, conn in pairs(getconnections(button.MouseButton1Click)) do
		conn.Function()
	end
	toggled = not toggled
	label.Text = toggled and "TOGGLE ON" or "TOGGLE OFF"
end

-- Find the toggle button in CoreGui
local function getToggleButton()
	local success, button = pcall(function()
		return CoreGui.Folder["chilli booster"].Pill.Toggle:WaitForChild("TextButton")
	end)
	if success then
		return button
	end
	return nil
end

-- G key press handler
UserInputService.InputBegan:Connect(function(input, gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.G then
		clickDeltaButton(toggleButtonRef)
	end
end)

-- Main loop to monitor toggle
task.spawn(function()
	while true do
		local toggleButton = getToggleButton()
		if toggleButton then
			toggleButtonRef = toggleButton

			local function syncToggle()
				local stealing = player:GetAttribute("Stealing")
				if stealing and not toggled then
					clickDeltaButton(toggleButton)
				elseif not stealing and toggled then
					clickDeltaButton(toggleButton)
				end
			end

			player:GetAttributeChangedSignal("Stealing"):Connect(syncToggle)
			syncToggle()

			toggleButton.AncestryChanged:Connect(function(_, parent)
				if not parent then
					toggled = false
					label.Text = "TOGGLE OFF"
					toggleButtonRef = nil
				end
			end)

			break
		end
		task.wait(1)
	end
end)
